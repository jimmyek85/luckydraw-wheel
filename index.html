<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1602 Lucky Draw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a202c;
            color: #f7fafc;
        }
        .wheel-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: auto;
        }
        
        /* Ê∑ªÂä†Â§ñÂúàÈúìËôπÁÅØË£ÖÈ•∞ */
        .wheel-container::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            background: transparent;
            border: 2px solid transparent;
            background-image: linear-gradient(45deg, #ff0080, #00ff80, #8000ff, #ff8000);
            background-size: 400% 400%;
            animation: gradient-rotate 3s ease infinite;
            z-index: -1;
        }
        
        .wheel-container::after {
            content: '';
            position: absolute;
            top: -25px;
            left: -25px;
            right: -25px;
            bottom: -25px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.5),
                inset 0 0 20px rgba(255, 0, 255, 0.3);
            animation: outer-glow 4s ease-in-out infinite alternate;
            z-index: -2;
        }
        
        @keyframes gradient-rotate {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes outer-glow {
            from {
                box-shadow: 
                    0 0 20px rgba(0, 255, 255, 0.5),
                    inset 0 0 20px rgba(255, 0, 255, 0.3);
            }
            to {
                box-shadow: 
                    0 0 40px rgba(255, 0, 255, 0.8),
                    inset 0 0 40px rgba(0, 255, 255, 0.5);
            }
        }
        #canvas {
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .pointer {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #ff8a8a, #f56565);
            border: 5px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .pointer::after {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 15px solid white;
        }
        .modal-bg {
            background-color: rgba(0,0,0,0.7);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #landing-page-container {
            background: #0d0d0d;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            animation: fadeIn 1s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(253, 224, 71, 0.2);
            animation: float 25s infinite linear;
            bottom: -50px;
        }
        @keyframes float {
            0% { transform: translateY(0) translateX(0); opacity: 0.5; }
            100% { transform: translateY(-100vh) translateX(var(--x-end)); opacity: 0; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        #wheel-wrapper {
            border-radius: 50%;
            transition: box-shadow 0.5s ease-in-out;
            /* Â∏∏‰∫ÆÁöÑÈúìËôπËæπÊ°Ü */
            box-shadow: 
                0 0 10px #00ffff,
                0 0 20px #00ffff,
                0 0 30px #00ffff,
                0 0 40px #00ffff,
                inset 0 0 10px #00ffff;
            border: 3px solid #00ffff;
            animation: neon-glow 2s ease-in-out infinite alternate;
        }
        
        /* Â∏∏‰∫ÆÈúìËôπÁÅØÊïàÊûú */
        @keyframes neon-glow {
            from {
                box-shadow: 
                    0 0 10px #00ffff,
                    0 0 20px #00ffff,
                    0 0 30px #00ffff,
                    0 0 40px #00ffff,
                    inset 0 0 10px #00ffff;
                border-color: #00ffff;
            }
            to {
                box-shadow: 
                    0 0 15px #ff00ff,
                    0 0 25px #ff00ff,
                    0 0 35px #ff00ff,
                    0 0 45px #ff00ff,
                    inset 0 0 15px #ff00ff;
                border-color: #ff00ff;
            }
        }
        
        /* ÊóãËΩ¨Êó∂ÁöÑÈó™ÁÉÅÈúìËôπÊïàÊûú */
        .spinning-neon {
            animation: neon-flicker 0.3s infinite, neon-glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes neon-flicker {
            0% {
                box-shadow: 
                    0 0 20px #ff0000,
                    0 0 30px #ff0000,
                    0 0 40px #ff0000,
                    0 0 50px #ff0000,
                    0 0 60px #ff0000,
                    inset 0 0 20px #ff0000;
                border-color: #ff0000;
            }
            25% {
                box-shadow: 
                    0 0 20px #00ff00,
                    0 0 30px #00ff00,
                    0 0 40px #00ff00,
                    0 0 50px #00ff00,
                    0 0 60px #00ff00,
                    inset 0 0 20px #00ff00;
                border-color: #00ff00;
            }
            50% {
                box-shadow: 
                    0 0 20px #0000ff,
                    0 0 30px #0000ff,
                    0 0 40px #0000ff,
                    0 0 50px #0000ff,
                    0 0 60px #0000ff,
                    inset 0 0 20px #0000ff;
                border-color: #0000ff;
            }
            75% {
                box-shadow: 
                    0 0 20px #ffff00,
                    0 0 30px #ffff00,
                    0 0 40px #ffff00,
                    0 0 50px #ffff00,
                    0 0 60px #ffff00,
                    inset 0 0 20px #ffff00;
                border-color: #ffff00;
            }
            100% {
                box-shadow: 
                    0 0 20px #ff00ff,
                    0 0 30px #ff00ff,
                    0 0 40px #ff00ff,
                    0 0 50px #ff00ff,
                    0 0 60px #ff00ff,
                    inset 0 0 20px #ff00ff;
                border-color: #ff00ff;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-md mx-auto">

        <!-- Language Switcher -->
        <div class="text-center mb-4">
            <button id="lang-en" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm">English</button>
            <button id="lang-zh" class="px-3 py-1 bg-gray-600 text-white rounded-md text-sm">‰∏≠Êñá</button>
        </div>

        <!-- Engaging Landing Page -->
        <div id="landing-page-container">
            <div id="particles-container"></div>
            <div id="landing-page" class="text-center relative z-10">
                <h1 class="text-4xl font-bold mb-2 text-yellow-300" data-lang-en="A Surprise Awaits!">A Surprise Awaits!</h1>
                <p class="text-lg mb-4 text-white" data-lang-en="Meeting is fate, a gift is our bond.">Meeting is fate, a gift is our bond.</p>
                <div class="bg-white p-2 rounded-lg inline-block my-4 shadow-lg">
                     <img src="https://storage2.me-qr.com/qr/231358832.png" alt="1602 Lucky Draw QR Code" class="w-48 h-48">
                </div>
                <p class="mt-4 text-sm text-gray-300" data-lang-en="Scan or Click Below to Join!">Scan or Click Below to Join!</p>
                <button id="fast-track-btn" class="mt-6 w-full bg-gradient-to-r from-yellow-400 to-amber-500 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105" data-lang-en="Enter Now">Enter Now</button>
            </div>
        </div>

        <!-- Registration Form -->
        <div id="register-page" class="hidden">
            <h2 class="text-2xl font-bold text-center mb-4" data-lang-en="Become a 1602 Member">Become a 1602 Member</h2>
            <p class="text-center mb-6 text-gray-300" data-lang-en="Fill in your details to get 1 free spin!">Fill in your details to get 1 free spin!</p>
            <form id="register-form">
                <div class="mb-4">
                    <label for="name" class="block mb-2 text-sm font-medium" data-lang-en="Name (Required)">Name (Required)</label>
                    <input type="text" id="name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="phone" class="block mb-2 text-sm font-medium" data-lang-en="Phone (Required)">Phone (Required)</label>
                    <div class="flex">
                        <select id="country-code" class="bg-gray-700 border border-r-0 border-gray-600 rounded-l-lg p-2.5 text-white focus:outline-none">
                        </select>
                        <input type="tel" id="phone" class="w-full bg-gray-700 border border-gray-600 rounded-r-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" placeholder="1123456789" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="email" class="block mb-2 text-sm font-medium" data-lang-en="Email (Optional)">Email (Optional)</label>
                    <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="address" class="block mb-2 text-sm font-medium" data-lang-en="Address (Optional)">Address (Optional)</label>
                    <input type="text" id="address" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" id="submit-register" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105" data-lang-en="Submit & Get Spin!">Submit & Get Spin!</button>
            </form>
        </div>

        <!-- Lucky Wheel Page -->
        <div id="wheel-page" class="hidden text-center">
            <h2 class="text-3xl font-bold mb-2" data-lang-en="1602 Lucky Draw">1602 Lucky Draw</h2>
            <p class="mb-4" data-lang-en="Welcome, "><span id="user-name-display"></span>!</p>
            <div id="wheel-wrapper" class="p-2 inline-block">
                <div class="wheel-container">
                    <div class="pointer"></div>
                    <canvas id="canvas" width="400" height="400"></canvas>
                </div>
            </div>
            <button id="spin-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                <span data-lang-en="SPIN">SPIN</span> (<span id="chances-left">0</span> <span data-lang-en="chances left">chances left</span>)
            </button>
            <div class="mt-4 flex justify-center gap-4 flex-wrap">
                <button id="my-prizes-btn" class="text-sm text-gray-400 hover:text-white hidden" data-lang-en="My Prizes">My Prizes</button>
                <button id="tnc-btn" class="text-sm text-gray-400 hover:text-white" data-lang-en="Prize T&C">Prize T&C</button>
                <button id="beer-sommelier-btn" class="text-sm text-purple-400 hover:text-purple-300 font-bold" data-lang-en="‚ú® AI Beer Recommendation">‚ú® AI Beer Recommendation</button>
                <button id="packages-btn" class="text-sm text-gray-400 hover:text-white" data-lang-en="Our Packages">Our Packages</button>
                <button id="feedback-btn" class="text-sm text-gray-400 hover:text-white" data-lang-en="Feedback">Feedback</button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50 p-4">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-sm w-full mx-auto text-center">
            <h3 id="modal-title" class="text-3xl font-bold mb-4"></h3>
            <div id="modal-content">
                <p id="modal-text" class="text-lg mb-2"></p>
                <div id="online-voucher-instructions" class="hidden text-sm mt-4 p-3 bg-gray-700 rounded-lg">
                    <p class="font-bold mb-2" data-lang-en="How to Claim Your Online Voucher:">How to Claim Your Online Voucher:</p>
                    <p data-lang-en="Download our '1602craftbeer' app to redeem your prize!">Download our '1602craftbeer' app to redeem your prize!</p>
                    <div class="flex justify-center gap-4 mt-2">
                        <a href="https://apps.apple.com/your-app-link" target="_blank" class="opacity-80 hover:opacity-100"><img src="https://placehold.co/120x40/000000/FFFFFF?text=App+Store" alt="Download on the App Store"></a>
                        <a href="https://play.google.com/store/apps/details?id=your.app.id" target="_blank" class="opacity-80 hover:opacity-100"><img src="https://placehold.co/120x40/000000/FFFFFF?text=Google+Play" alt="Get it on Google Play"></a>
                    </div>
                </div>
                <button id="gemini-idea-btn" class="hidden w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 my-4">
                    ‚ú® <span data-lang-en="AI, give me an idea!">AI, give me an idea!</span>
                </button>
            </div>
            <div id="gemini-loading" class="hidden">
                <div class="loader"></div>
                <p data-lang-en="Our AI is thinking...">Our AI is thinking...</p>
            </div>
            <div id="share-section" class="mt-4 pt-4 border-t border-gray-600">
                <p class="mb-3 text-sm" data-lang-en="Share to get a RM2 cash voucher!">Share to get a RM2 cash voucher!</p>
                <div class="flex justify-center space-x-4">
                    <button onclick="share('facebook')" class="bg-blue-800 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v2.385z"/></svg></button>
                    <button onclick="share('instagram')" class="bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.069-4.85.069-3.204 0-3.584-.012-4.849-.069-3.225-.149-4.771-1.664-4.919-4.919-.058-1.265-.069-1.645-.069-4.849 0-3.204.012-3.584.069-4.849.149-3.225 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.689-.073-4.948-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44 1.441-.645 1.441-1.44-.645-1.44-1.441-1.44z"/></svg></button>
                    <button onclick="share('copy_whatsapp')" class="bg-gray-500 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                </div>
            </div>
            <button id="modal-close-btn" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg" data-lang-en="Close">Close</button>
        </div>
    </div>

    <!-- Generic Modal for T&C, Packages, and Announcements -->
    <div id="generic-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50 p-4">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-lg w-full mx-auto text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 id="generic-modal-title" class="text-2xl font-bold"></h3>
                <button id="generic-modal-close-btn" class="text-2xl leading-none">&times;</button>
            </div>
            <div id="generic-modal-content" class="text-gray-300 text-sm space-y-2 max-h-[60vh] overflow-y-auto">
            </div>
        </div>
    </div>

    <!-- AI Beer Sommelier Modal -->
    <div id="beer-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50 p-4">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-lg w-full mx-auto text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 id="beer-modal-title" class="text-2xl font-bold" data-lang-en="‚ú® AI Beer Sommelier">‚ú® AI Beer Sommelier</h3>
                <button id="beer-modal-close-btn" class="text-2xl leading-none">&times;</button>
            </div>
            <div id="beer-modal-content">
                <p class="mb-4" data-lang-en="What kind of flavor are you in the mood for?">What kind of flavor are you in the mood for?</p>
                <div class="space-y-3">
                    <button data-flavor="Pale Ale" class="beer-flavor-btn w-full text-left p-3 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors" data-lang-en="Pale Ale (Fruity & Light)">Pale Ale (Fruity & Light)</button>
                    <button data-flavor="Extra Dark" class="beer-flavor-btn w-full text-left p-3 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors" data-lang-en="Extra Dark (Rich & Malty)">Extra Dark (Rich & Malty)</button>
                    <button data-flavor="Lager" class="beer-flavor-btn w-full text-left p-3 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors" data-lang-en="Lager (Classic & Crisp)">Lager (Classic & Crisp)</button>
                </div>
            </div>
             <div id="beer-loading" class="hidden">
                <div class="loader"></div>
                <p class="text-center" data-lang-en="Our AI Sommelier is pouring a recommendation...">Our AI Sommelier is pouring a recommendation...</p>
            </div>
            <div id="beer-recommendation" class="hidden mt-4 text-purple-300 italic"></div>
        </div>
    </div>

    <!-- ADDED: Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50 p-4">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-lg w-full mx-auto text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold" data-lang-en="Give us your Feedback">Give us your Feedback</h3>
                <button id="feedback-modal-close-btn" class="text-2xl leading-none">&times;</button>
            </div>
            <div>
                <textarea id="feedback-textarea" class="w-full h-32 p-3 bg-gray-700 border border-gray-600 rounded-md text-white" data-lang-en-placeholder="Your feedback is valuable to us..."></textarea>
                <button id="submit-feedback-btn" class="mt-4 w-full bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition" data-lang-en="Submit Feedback">Submit Feedback</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDR9ApYQZbHJpbs3hSiY1wdGjSOIxWpZIY",
            authDomain: "deductive-smile-408711.firebaseapp.com",
            projectId: "deductive-smile-408711",
            storageBucket: "deductive-smile-408711.appspot.com",
            messagingSenderId: "209601875553",
            appId: "1:209601875553:web:d4a9175622134295c06420",
            measurementId: "G-R222P71DDD"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const langData = {
            en: {
                "Welcome to 1602": "Welcome to 1602",
                "Scan the QR code to participate!": "Scan the QR code to participate!",
                "This is the official entry point for the 1602 Lucky Draw.": "This is the official entry point for the 1602 Lucky Draw.",
                "A Surprise Awaits!": "A Surprise Awaits!",
                "Meeting is fate, a gift is our bond.": "Meeting is fate, a gift is our bond.",
                "Scan or Click Below to Join!": "Scan or Click Below to Join!",
                "Enter Now": "Enter Now",
                "Become a 1602 Member": "Become a 1602 Member",
                "Fill in your details to get 1 free spin!": "Fill in your details to get 1 free spin!",
                "Name (Required)": "Name (Required)",
                "Phone (Required)": "Phone (Required)",
                "Email (Optional)": "Email (Optional)",
                "Address (Optional)": "Address (Optional)",
                "Submit & Get Spin!": "Submit & Get Spin!",
                "1602 Lucky Draw": "1602 Lucky Draw",
                "Welcome, ": "Welcome, ",
                "SPIN": "SPIN",
                "chances left": "chances left",
                "Share to get a RM2 cash voucher!": "Share to get a RM2 cash voucher!",
                "Close": "Close",
                "AI, give me an idea!": "AI, give me an idea!",
                "Our AI is thinking...": "Our AI is thinking...",
                "Prize T&C": "Prize T&C",
                "Our Packages": "Our Packages",
                "My Prizes": "My Prizes",
                "Feedback": "Feedback",
                "How to Claim Your Online Voucher:": "How to Claim Your Online Voucher:",
                "Download our '1602craftbeer' app to redeem your prize!": "Download our '1602craftbeer' app to redeem your prize!",
                "Terms & Conditions": "Terms & Conditions",
                "1602 Packages": "1602 Packages",
                "‚ú® AI Beer Recommendation": "‚ú® AI Beer Recommendation",
                "‚ú® AI Beer Sommelier": "‚ú® AI Beer Sommelier",
                "What kind of flavor are you in the mood for?": "What kind of flavor are you in the mood for?",
                "Pale Ale (Fruity & Light)": "Pale Ale (Fruity & Light)",
                "Extra Dark (Rich & Malty)": "Extra Dark (Rich & Malty)",
                "Lager (Classic & Crisp)": "Lager (Classic & Crisp)",
                "Our AI Sommelier is pouring a recommendation...": "Our AI Sommelier is pouring a recommendation...",
                "Event Announcement": "Event Announcement",
                "Your Prizes": "Your Prizes",
                "Like & Follow us on Facebook for an instant RM2 cash voucher!": "Like & Follow us on Facebook for an instant RM2 cash voucher!",
                "Search for 'Sarawakian Craft Beer - Kuching Beer Catering Service', show our staff, and claim your voucher now!": "Search for 'Sarawakian Craft Beer - Kuching Beer Catering Service', show our staff, and claim your voucher now!",
                "Give us your Feedback": "Give us your Feedback",
                "Your feedback is valuable to us...": "Your feedback is valuable to us...",
                "Submit Feedback": "Submit Feedback",
                "Feedback submitted. Thank you!": "Feedback submitted. Thank you!",
                "Wine Card": "Wine Card",
                "RM5 Cash voucher": "RM5 Cash voucher",
                "RM10 Online Cash voucher": "RM10 Online Cash voucher",
                "RM20 Online Cash voucher": "RM20 Online Cash voucher",
                "330ml Lager Smooth": "330ml Lager Smooth",
                "660ml Bottle": "660ml Bottle",
                "1602 Pen": "1602 Pen",
                "1602 Cooler Bag": "1602 Cooler Bag",
                "1602 mug": "1602 mug",
                "Thank You": "Thank You",
                "Spin Again!": "Spin Again!",
                "Beer Card": "Beer Card",
                "Congratulations!": "Congratulations!",
                "Oh No...": "Oh No...",
                "Awesome!": "Awesome!",
                "You won a": "You won a",
                "Better luck next time!": "Better luck next time!",
                "You get another free spin!": "You get another free spin!",
                "Copied to clipboard!": "Copied to clipboard!",
                "User already exists. Loading your data...": "User already exists. Loading your data...",
                "Registration successful!": "Registration successful!",
                "Please fill in required fields.": "Please fill in required fields.",
                "Please enter a valid phone number (digits only).": "Please enter a valid phone number (digits only)."
            },
            zh: {
                "Welcome to 1602": "Ê¨¢ËøéÊù•Âà∞ 1602",
                "Scan the QR code to participate!": "ËØ∑Êâ´Êèè‰∫åÁª¥Á†ÅÂèÇ‰∏éÊ¥ªÂä®ÔºÅ",
                "This is the official entry point for the 1602 Lucky Draw.": "ËøôÊòØ1602Âπ∏ËøêËΩÆÁõòÁöÑÂÆòÊñπÊ¥ªÂä®ÂÖ•Âè£„ÄÇ",
                "A Surprise Awaits!": "Êâ´Á†ÅÊúâÊÉäÂñúÔºÅ",
                "Meeting is fate, a gift is our bond.": "‰∏é‰Ω†Áõ∏ÈÅáÊòØÁºòÂàÜÔºåÊâ´Á†ÅÈÄÅÁ§ºÁªìÊÉÖÂàÜ„ÄÇ",
                "Scan or Click Below to Join!": "Êâ´ÊèèÊàñÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂèÇ‰∏éÔºÅ",
                "Enter Now": "Âø´Êç∑ÈÄöÈÅì",
                "Become a 1602 Member": "Êàê‰∏∫ 1602 ‰ºöÂëò",
                "Fill in your details to get 1 free spin!": "Â°´ÂÜôËµÑÊñôÂç≥ÂèØËé∑Âæó1Ê¨°ÂÖçË¥πÊäΩÂ•ñÊú∫‰ºöÔºÅ",
                "Name (Required)": "ÂêçÂ≠óÔºàÂøÖÂ°´Ôºâ",
                "Phone (Required)": "ÁîµËØùÔºàÂøÖÂ°´Ôºâ",
                "Email (Optional)": "ÈÇÆÁÆ±ÔºàÈÄâÂ°´Ôºâ",
                "Address (Optional)": "Âú∞ÂùÄÔºàÈÄâÂ°´Ôºâ",
                "Submit & Get Spin!": "Êèê‰∫§Âπ∂Ëé∑ÂèñÊäΩÂ•ñÊú∫‰ºöÔºÅ",
                "1602 Lucky Draw": "1602 Âπ∏ËøêËΩÆÁõò",
                "Welcome, ": "Ê¨¢Ëøé, ",
                "SPIN": "ÂºÄÂßãÊäΩÂ•ñ",
                "chances left": "Ê¨°Êú∫‰ºö",
                "Share to get a RM2 cash voucher!": "ÊàêÂäüÂàÜ‰∫´ÂèØËé∑ÂæóRM2Áé∞ÈáëÂà∏ÔºÅ",
                "Close": "ÂÖ≥Èó≠",
                "AI, give me an idea!": "AIÁªôÊàë‰∏Ä‰∏™Â•Ω‰∏ªÊÑèÔºÅ",
                "Our AI is thinking...": "AIÊ≠£Âú®‰∏∫ÊÇ®ÁîüÊàêÂàõÊÑè...",
                "Prize T&C": "È¢ÜÂ•ñ T&C",
                "Our Packages": "‰ºòÊÉ†Â•óÈ§ê",
                "My Prizes": "ÊàëÁöÑÂ•ñÂìÅ",
                "Feedback": "ÂÆ¢Êà∑ÂèçÈ¶à",
                "How to Claim Your Online Voucher:": "Â¶Ç‰ΩïÈ¢ÜÂèñÊÇ®ÁöÑÁ∫ø‰∏ä‰ª£ÈáëÂà∏:",
                "Download our '1602craftbeer' app to redeem your prize!": "ËØ∑‰∏ãËΩΩÊàë‰ª¨ÁöÑ ‚Äú1602craftbeer‚Äù App È¢ÜÂèñÊÇ®ÁöÑÂ•ñÂä±ÔºÅ",
                "Terms & Conditions": "Êù°Ê¨æ‰∏éËßÑÂÆö",
                "1602 Packages": "1602 ‰ºòÊÉ†Â•óÈ§ê",
                "‚ú® AI Beer Recommendation": "‚ú® AI Âï§ÈÖíÊé®Ëçê",
                "‚ú® AI Beer Sommelier": "‚ú® AI Âï§ÈÖíÂìÅÈâ¥È°æÈóÆ",
                "What kind of flavor are you in the mood for?": "ÊÇ®‰ªäÂ§©ÊÉ≥ÂñùÁÇπ‰ªÄ‰πàÂè£Âë≥Ôºü",
                "Pale Ale (Fruity & Light)": "Ê∏ÖÁàΩÊûúÈ¶ô (Pale Ale)",
                "Extra Dark (Rich & Malty)": "ÊµìÈÉÅÈ∫¶È¶ô (Extra Dark)",
                "Lager (Classic & Crisp)": "ÁªèÂÖ∏ÂéüÂë≥ (Lager)",
                "Event Announcement": "Ê¥ªÂä®ÂÖ¨Âëä",
                "Your Prizes": "ÊÇ®ÁöÑÂ•ñÂìÅ",
                "Like & Follow us on Facebook for an instant RM2 cash voucher!": "ÁÇπËµûÂπ∂ÂÖ≥Ê≥®Êàë‰ª¨ÁöÑFBÔºåÂç≥ÂèØÁ´ãÂç≥Ëé∑ÂæóRM2Áé∞ÈáëÂà∏ÔºÅ",
                "Search for 'Sarawakian Craft Beer - Kuching Beer Catering Service', show our staff, and claim your voucher now!": "ËØ∑ÊêúÁ¥¢‚ÄòSarawakian Craft Beer - Kuching Beer Catering Service‚ÄôÔºåÂêëÂ∑•‰Ωú‰∫∫ÂëòÂ±ïÁ§∫ÔºåÂç≥ÂèØÈ©¨‰∏ä‰ΩøÁî®ÊÇ®ÁöÑÁé∞ÈáëÂà∏ÔºÅ",
                "Give us your Feedback": "ÁªôÊàë‰ª¨‰∏Ä‰∫õÂèçÈ¶à",
                "Your feedback is valuable to us...": "ÊÇ®ÁöÑÂèçÈ¶àÂØπÊàë‰ª¨ÈùûÂ∏∏ÂÆùË¥µ...",
                "Submit Feedback": "Êèê‰∫§ÂèçÈ¶à",
                "Feedback submitted. Thank you!": "ÂèçÈ¶àÂ∑≤Êèê‰∫§ÔºåË∞¢Ë∞¢ÊÇ®ÔºÅ",
                "Wine Card": "ÈÖíÂç°",
                "RM5 Cash voucher": "Áé∞ÈáëÂà∏RM5",
                "RM10 Online Cash voucher": "Á∫ø‰∏äÁé∞ÈáëÂà∏RM10",
                "RM20 Online Cash voucher": "Á∫ø‰∏äÁé∞ÈáëÂà∏RM20",
                "330ml Lager Smooth": "330mlÊñ∞ÂìÅLager Smooth 1ÁΩê",
                "660ml Bottle": "660mlÁì∂Ë£Ö 1Áì∂",
                "1602 Pen": "1602Á∫™ÂøµÁ¨î",
                "1602 Cooler Bag": "1602‰øùÂÜ∑Ë¢ã",
                "1602 mug": "1602Á∫™ÂøµÈô∂Áì∑ÊùØ",
                "Thank You": "Ë∞¢Ë∞¢ÂèÇ‰∏é",
                "Spin Again!": "ÂÜçÊù•‰∏ÄÊ¨°ÔºÅ",
                "Beer Card": "ÈÖíÂç°",
                "Congratulations!": "ÊÅ≠ÂñúÔºÅ",
                "Oh No...": "ÂæàÈÅóÊÜæ...",
                "Awesome!": "Â§™Ê£í‰∫ÜÔºÅ",
                "You won a": "ÊÇ®ÊäΩ‰∏≠‰∫Ü",
                "Better luck next time!": "Á•ùÊÇ®‰∏ãÊ¨°Â•ΩËøêÔºÅ",
                "You get another free spin!": "ÊÇ®Ëé∑Âæó‰∫Ü‰∏ÄÊ¨°È¢ùÂ§ñÊäΩÂ•ñÊú∫‰ºöÔºÅ",
                "Copied to clipboard!": "Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ",
                "User already exists. Loading your data...": "Áî®Êà∑Â∑≤Â≠òÂú®ÔºåÊ≠£Âú®Âä†ËΩΩÊÇ®ÁöÑÊï∞ÊçÆ...",
                "Registration successful!": "Ê≥®ÂÜåÊàêÂäüÔºÅ",
                "Please fill in required fields.": "ËØ∑Â°´ÂÜôÂøÖÂ°´È°π„ÄÇ",
                "Please enter a valid phone number (digits only).": "ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÁîµËØùÂè∑Á†ÅÔºà‰ªÖÈôêÊï∞Â≠óÔºâ„ÄÇ"
            }
        };

        // Global variables
        let currentLang = 'en';
        let knowledgeBaseContent = '';
        let currentUser = null;
        let userDataListener = null;

        // Real-time user data listener
        function setupUserDataListener(userId) {
            // Remove existing listener if any
            if (userDataListener) {
                userDataListener();
                userDataListener = null;
            }

            // Set up new listener for current user
            const userRef = doc(db, 'users', userId);
            userDataListener = onSnapshot(userRef, (doc) => {
                if (doc.exists()) {
                    const userData = doc.data();
                    currentUser = { id: doc.id, ...userData };
                    
                    // Update UI with real-time data
                    updateUserInterface(userData);
                    
                    console.log('User data updated in real-time:', userData);
                } else {
                    console.log('User document does not exist');
                }
            }, (error) => {
                console.error('Error listening to user data:', error);
            });
        }

        // Update user interface with real-time data
        function updateUserInterface(userData) {
            const userNameDisplay = document.getElementById('user-name-display');
            const chancesLeft = document.getElementById('chances-left');
            
            if (userNameDisplay) {
                userNameDisplay.textContent = userData.name || 'User';
            }
            
            if (chancesLeft) {
                chancesLeft.textContent = userData.chances || 0;
            }

            // Update spin button state based on chances
            const spinBtn = document.getElementById('spin-btn');
            if (spinBtn) {
                spinBtn.disabled = (userData.chances || 0) <= 0;
                if (userData.chances <= 0) {
                    spinBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    spinBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // Real-time settings listener
        function setupSettingsListener() {
            const settingsRef = doc(db, 'settings', 'app');
            onSnapshot(settingsRef, (doc) => {
                if (doc.exists()) {
                    const settings = doc.data();
                    
                    // Update announcement if changed
                    if (settings.announcement) {
                        showAnnouncement(settings.announcement);
                    }
                    
                    // Update knowledge base
                    if (settings.knowledge) {
                        knowledgeBaseContent = settings.knowledge;
                    }
                    
                    console.log('Settings updated in real-time:', settings);
                }
            }, (error) => {
                console.error('Error listening to settings:', error);
            });
        }

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            console.error('Error message:', e.message);
            console.error('Error filename:', e.filename);
            console.error('Error line:', e.lineno);
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            e.preventDefault();
        });

        // Enhanced user data update function
        async function updateUserData(userId, updates) {
            try {
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, {
                    ...updates,
                    lastUpdated: serverTimestamp()
                });
                console.log('User data updated successfully:', updates);
            } catch (error) {
                console.error('Error updating user data:', error);
                throw error;
            }
        }

        // Language switching function
        function switchLanguage(lang) {
            currentLang = lang;
            const elements = document.querySelectorAll('[data-lang-en]');
            elements.forEach(element => {
                const key = element.getAttribute('data-lang-en');
                if (langData[lang] && langData[lang][key]) {
                    element.textContent = langData[lang][key];
                }
            });
        }

        // Fetch settings from Firestore
        async function fetchSettings() {
            try {
                console.log('üìã Fetching settings from Firestore...');
                const settingsDoc = await getDoc(doc(db, 'settings', 'app'));
                if (settingsDoc.exists()) {
                    const settings = settingsDoc.data();
                    console.log('‚úÖ Settings loaded:', settings);
                    if (settings.announcement) {
                        showAnnouncement(settings.announcement);
                    }
                    if (settings.knowledge) {
                        knowledgeBaseContent = settings.knowledge;
                    }
                } else {
                    console.log('‚ö†Ô∏è Settings document does not exist, creating default settings...');
                    await initializeDefaultSettings();
                }
            } catch (error) {
                console.error("‚ùå Error fetching settings:", error);
                // Continue without settings if there's an error
            }
        }

        // Initialize default settings if they don't exist
        async function initializeDefaultSettings() {
            try {
                const defaultSettings = {
                    announcement: '',
                    knowledge: 'Welcome to 1602 Lucky Draw! Spin the wheel to win amazing prizes.',
                    lastUpdated: serverTimestamp()
                };
                
                await setDoc(doc(db, 'settings', 'app'), defaultSettings);
                console.log('‚úÖ Default settings created successfully');
            } catch (error) {
                console.error('‚ùå Error creating default settings:', error);
            }
        }

        // Test Firestore connection
        async function testFirestoreConnection() {
            try {
                console.log('üß™ Testing Firestore read/write operations...');
                
                // Test write operation
                const testDoc = doc(db, 'test', 'connection');
                await setDoc(testDoc, {
                    timestamp: serverTimestamp(),
                    test: 'connection_test'
                });
                console.log('‚úÖ Firestore write test successful');
                
                // Test read operation
                const testRead = await getDoc(testDoc);
                if (testRead.exists()) {
                    console.log('‚úÖ Firestore read test successful:', testRead.data());
                } else {
                    console.log('‚ö†Ô∏è Firestore read test: document not found');
                }
                
                console.log('‚úÖ Firestore connection test completed successfully');
            } catch (error) {
                console.error('‚ùå Firestore connection test failed:', error);
                throw error;
            }
        }

        // Show announcement modal
        function showAnnouncement(announcement) {
            if (announcement.trim()) {
                const modal = document.getElementById('generic-modal');
                const title = document.getElementById('generic-modal-title');
                const content = document.getElementById('generic-modal-content');
                
                title.textContent = langData[currentLang]["Event Announcement"] || "Event Announcement";
                content.innerHTML = `<p class="text-gray-700">${announcement}</p>`;
                modal.classList.remove('hidden');
            }
        }

        // Create background particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 2) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Populate country codes dropdown
        function populateCountryCodes() {
            const countryCodeSelect = document.getElementById('country-code');
            if (!countryCodeSelect) return;
            
            const countryCodes = [
                { code: '+60', country: 'Malaysia' },
                { code: '+65', country: 'Singapore' },
                { code: '+1', country: 'US/Canada' },
                { code: '+44', country: 'UK' },
                { code: '+86', country: 'China' },
                { code: '+81', country: 'Japan' },
                { code: '+82', country: 'South Korea' }
            ];
            
            countryCodes.forEach(item => {
                const option = document.createElement('option');
                option.value = item.code;
                option.textContent = `${item.code} ${item.country}`;
                countryCodeSelect.appendChild(option);
            });
        }

        // Draw the wheel
        function drawWheel() {
            const canvas = document.getElementById('canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 180;
            
            const prizes = [
                { text: 'Beer Card', color: '#FF6B6B', textColor: '#FFFFFF', weight: 0 },
                { text: 'RM5 Cash voucher', color: '#4ECDC4', textColor: '#FFFFFF', weight: 16 },
                { text: 'RM10 Online Cash voucher', color: '#45B7D1', textColor: '#FFFFFF', weight: 9 },
                { text: 'RM20 Online Cash voucher', color: '#96CEB4', textColor: '#FFFFFF', weight: 6 },
                { text: '330ml Lager Smooth', color: '#FFEAA7', textColor: '#2D3436', weight: 9 },
                { text: '660ml Bottle', color: '#DDA0DD', textColor: '#FFFFFF', weight: 6 },
                { text: '1602 Pen', color: '#98D8C8', textColor: '#2D3436', weight: 12 },
                { text: '1602 Cooler Bag', color: '#F7DC6F', textColor: '#2D3436', weight: 12 },
                { text: '1602 mug', color: '#BB8FCE', textColor: '#FFFFFF', weight: 0 },
                { text: 'Thank You', color: '#85C1E9', textColor: '#2D3436', weight: 14 },
                { text: 'Spin Again!', color: '#F8C471', textColor: '#2D3436', weight: 16 }
            ];
            
            const anglePerSlice = (2 * Math.PI) / prizes.length;
            
            prizes.forEach((prize, index) => {
                const startAngle = index * anglePerSlice;
                const endAngle = startAngle + anglePerSlice;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = prize.color;
                ctx.fill();
                ctx.stroke();
                
                // Draw text
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(startAngle + anglePerSlice / 2);
                ctx.textAlign = 'center';
                ctx.fillStyle = prize.textColor;
                ctx.font = 'bold 10px Arial'; // ÂáèÂ∞èÂ≠ó‰ΩìÂ§ßÂ∞è
                
                // Split text into multiple lines for better display
                const text = prize.text;
                const words = text.split(' ');
                const maxWidth = radius * 0.4; // ÈôêÂà∂ÊñáÂ≠óÂÆΩÂ∫¶
                const textRadius = radius * 0.65; // Ë∞ÉÊï¥ÊñáÂ≠ó‰ΩçÁΩÆÊõ¥Èù†Ëøë‰∏≠ÂøÉ
                
                if (words.length > 2 || ctx.measureText(text).width > maxWidth) {
                    // ÈïøÊñáÂ≠óÂàÜË°åÊòæÁ§∫
                    if (words.length >= 3) {
                        ctx.fillText(words.slice(0, 2).join(' '), textRadius, -6);
                        ctx.fillText(words.slice(2).join(' '), textRadius, 6);
                    } else if (words.length === 2) {
                        ctx.fillText(words[0], textRadius, -6);
                        ctx.fillText(words[1], textRadius, 6);
                    } else {
                        // Âçï‰∏™ÈïøËØçÔºåÂ∞ùËØïÁº©Áü≠ÊòæÁ§∫
                        const shortText = text.length > 12 ? text.substring(0, 10) + '...' : text;
                        ctx.fillText(shortText, textRadius, 0);
                    }
                } else {
                    // Áü≠ÊñáÂ≠óÂçïË°åÊòæÁ§∫
                    ctx.fillText(text, textRadius, 0);
                }
                ctx.restore();
            });
        }

        // Handle registration form submission
        async function handleRegistration(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const countryCode = document.getElementById('country-code').value;
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const address = document.getElementById('address').value.trim();
            
            if (!name || !phone) {
                alert(langData[currentLang]["Please fill in required fields."] || "Please fill in required fields.");
                return;
            }
            
            if (!/^\d+$/.test(phone)) {
                alert(langData[currentLang]["Please enter a valid phone number (digits only)."] || "Please enter a valid phone number (digits only).");
                return;
            }
            
            const fullPhone = countryCode + phone;
            
            try {
                const userRef = doc(db, 'users', fullPhone);
                const userDoc = await getDoc(userRef);
                
                let userData;
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    
                    // Update existing user with enhanced function
                    await updateUserData(fullPhone, {
                        name: name,
                        email: email || userData.email || '',
                        address: address || userData.address || '',
                        lastLogin: serverTimestamp()
                    });
                    
                    alert(langData[currentLang]["User already exists. Loading your data..."] || "User already exists. Loading your data...");
                } else {
                    userData = {
                        name: name,
                        phone: fullPhone,
                        email: email || '',
                        address: address || '',
                        chances: 1,
                        prizes: [],
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp()
                    };
                    await setDoc(userRef, userData);
                    alert(langData[currentLang]["Registration successful!"] || "Registration successful!");
                }
                
                // Set up real-time listener for this user
                setupUserDataListener(fullPhone);
                
                // Store current user ID for future operations
                window.currentUserId = fullPhone;
                
                // Switch to wheel page first
                document.getElementById('register-page').classList.add('hidden');
                document.getElementById('wheel-page').classList.remove('hidden');
                
                // The UI will be updated automatically by the real-time listener
                
            } catch (error) {
                console.error("Registration error:", error);
                alert("Registration failed. Please try again.");
            }
        }

        // Spin the wheel
        async function spin() {
            const spinBtn = document.getElementById('spin-btn');
            const chancesLeft = parseInt(document.getElementById('chances-left').textContent);
            
            if (chancesLeft <= 0) {
                alert("No chances left!");
                return;
            }
            
            if (!window.currentUserId) {
                alert("User not found. Please register again.");
                return;
            }
            
            spinBtn.disabled = true;
            
            // Simulate spinning animation
            const wheel = document.getElementById('canvas');
            const wrapper = document.getElementById('wheel-wrapper');
            wrapper.classList.add('spinning-neon');
            
            const randomRotation = Math.random() * 360 + 1440; // At least 4 full rotations
            wheel.style.transform = `rotate(${randomRotation}deg)`;
            
            setTimeout(async () => {
                wrapper.classList.remove('spinning-neon');
                
                // Determine prize based on weighted probability
                const wonPrize = selectPrizeByWeight();
                
                try {
                    // Update user data in real-time
                    const updates = {
                        lastSpin: serverTimestamp()
                    };
                    
                    if (wonPrize === 'Spin Again!') {
                        // Don't reduce chances for "Spin Again!"
                        updates.prizes = arrayUnion({
                            prize: wonPrize,
                            timestamp: serverTimestamp()
                        });
                    } else {
                        // Reduce chances and add prize
                        updates.chances = Math.max(0, chancesLeft - 1);
                        updates.prizes = arrayUnion({
                            prize: wonPrize,
                            timestamp: serverTimestamp()
                        });
                    }
                    
                    await updateUserData(window.currentUserId, updates);
                    
                    showPrizeModal(wonPrize);
                    
                } catch (error) {
                    console.error('Error updating user data after spin:', error);
                    alert('Error saving spin result. Please try again.');
                }
                
                spinBtn.disabled = false;
                
            }, 3000);
        }

        // Select prize based on weight
        function selectPrizeByWeight() {
            const canvas = document.getElementById('canvas');
            if (!canvas) return 'Thank You';
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 180;
            
            const prizes = [
                { text: 'Beer Card', color: '#FF6B6B', textColor: '#FFFFFF', weight: 0 },
                { text: 'RM5 Cash voucher', color: '#4ECDC4', textColor: '#FFFFFF', weight: 16 },
                { text: 'RM10 Online Cash voucher', color: '#45B7D1', textColor: '#FFFFFF', weight: 9 },
                { text: 'RM20 Online Cash voucher', color: '#96CEB4', textColor: '#FFFFFF', weight: 6 },
                { text: '330ml Lager Smooth', color: '#FFEAA7', textColor: '#2D3436', weight: 9 },
                { text: '660ml Bottle', color: '#DDA0DD', textColor: '#FFFFFF', weight: 6 },
                { text: '1602 Pen', color: '#98D8C8', textColor: '#2D3436', weight: 12 },
                { text: '1602 Cooler Bag', color: '#F7DC6F', textColor: '#2D3436', weight: 12 },
                { text: '1602 mug', color: '#BB8FCE', textColor: '#FFFFFF', weight: 0 },
                { text: 'Thank You', color: '#85C1E9', textColor: '#2D3436', weight: 14 },
                { text: 'Spin Again!', color: '#F8C471', textColor: '#2D3436', weight: 16 }
            ];
            
            // Calculate total weight
            const totalWeight = prizes.reduce((sum, prize) => sum + prize.weight, 0);
            
            // Generate random number
            const random = Math.random() * totalWeight;
            
            // Find the selected prize
            let currentWeight = 0;
            for (const prize of prizes) {
                currentWeight += prize.weight;
                if (random <= currentWeight) {
                    return prize.text;
                }
            }
            
            // Fallback
            return 'Thank You';
        }

        // Show prize modal
        function showPrizeModal(prize) {
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            
            if (prize === 'Thank You') {
                title.textContent = langData[currentLang]["Oh No..."] || "Oh No...";
                content.innerHTML = `<p>${langData[currentLang]["Better luck next time!"] || "Better luck next time!"}</p>`;
            } else if (prize === 'Spin Again!') {
                title.textContent = langData[currentLang]["Awesome!"] || "Awesome!";
                content.innerHTML = `<p>${langData[currentLang]["You get another free spin!"] || "You get another free spin!"}</p>`;
            } else {
                title.textContent = langData[currentLang]["Congratulations!"] || "Congratulations!";
                content.innerHTML = `<p>${langData[currentLang]["You won a"] || "You won a"} ${langData[currentLang][prize] || prize}!</p>`;
            }
            
            modal.classList.remove('hidden');
        }

        // Show generic modal
        function showGenericModal(type) {
            const modal = document.getElementById('generic-modal');
            const title = document.getElementById('generic-modal-title');
            const content = document.getElementById('generic-modal-content');
            
            switch(type) {
                case 'tnc':
                    title.textContent = langData[currentLang]["Terms & Conditions"] || "Terms & Conditions";
                    content.innerHTML = `
                        <div class="space-y-4 text-gray-700">
                            <h4 class="font-semibold">${langData[currentLang]["How to Claim Your Online Voucher:"] || "How to Claim Your Online Voucher:"}</h4>
                            <p>${langData[currentLang]["Download our '1602craftbeer' app to redeem your prize!"] || "Download our '1602craftbeer' app to redeem your prize!"}</p>
                        </div>
                    `;
                    break;
                case 'packages':
                    title.textContent = langData[currentLang]["1602 Packages"] || "1602 Packages";
                    content.innerHTML = `<p class="text-gray-700">Package information will be displayed here.</p>`;
                    break;
                case 'my-prizes':
                    title.textContent = langData[currentLang]["Your Prizes"] || "Your Prizes";
                    content.innerHTML = `<p class="text-gray-700">Your prize history will be displayed here.</p>`;
                    break;
            }
            
            modal.classList.remove('hidden');
        }

        // Handle beer recommendation
        async function handleBeerRecommendation(flavor) {
            const loading = document.getElementById('beer-loading');
            const recommendation = document.getElementById('beer-recommendation');
            
            loading.classList.remove('hidden');
            recommendation.classList.add('hidden');
            
            // Simulate AI recommendation
            setTimeout(() => {
                loading.classList.add('hidden');
                recommendation.classList.remove('hidden');
                
                const recommendations = {
                    'Pale Ale': 'Based on your preference for fruity and light flavors, I recommend our 1602 Pale Ale! It features citrusy hop notes with a refreshing finish.',
                    'Extra Dark': 'For rich and malty flavors, try our 1602 Extra Dark! It offers deep chocolate and coffee notes with a smooth, full-bodied taste.',
                    'Lager': 'Our classic 1602 Lager is perfect for you! Clean, crisp, and refreshing with a balanced malt character.'
                };
                
                recommendation.textContent = recommendations[flavor] || 'Try our signature 1602 beer selection!';
            }, 2000);
        }

        // Submit feedback
        async function submitFeedback() {
            const textarea = document.getElementById('feedback-textarea');
            const feedback = textarea.value.trim();
            
            if (!feedback) return;
            
            try {
                await addDoc(collection(db, 'feedback'), {
                    feedback: feedback,
                    timestamp: new Date()
                });
                
                alert(langData[currentLang]["Feedback submitted. Thank you!"] || "Feedback submitted. Thank you!");
                textarea.value = '';
                document.getElementById('feedback-modal').classList.add('hidden');
            } catch (error) {
                console.error("Error submitting feedback:", error);
                alert("Failed to submit feedback. Please try again.");
            }
        }
        
        // All other variables and functions are defined below but omitted for brevity.
        // The full, correct code is in the script.
        
        async function initApp() {
            console.log('üöÄ Starting app initialization...');
            
            // FIXED: Moved all element lookups inside initApp to run after DOM is loaded
            const landingPageContainer = document.getElementById('landing-page-container');
            const registerPage = document.getElementById('register-page');
            const wheelPage = document.getElementById('wheel-page');
            const registerForm = document.getElementById('register-form');
            const spinBtn = document.getElementById('spin-btn');
            const chancesLeftSpan = document.getElementById('chances-left');
            const userNameDisplay = document.getElementById('user-name-display');
            const resultModal = document.getElementById('result-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalText = document.getElementById('modal-text');
            const onlineVoucherInstructions = document.getElementById('online-voucher-instructions');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const geminiIdeaBtn = document.getElementById('gemini-idea-btn');
            const geminiLoading = document.getElementById('gemini-loading');
            const genericModal = document.getElementById('generic-modal');
            const genericModalTitle = document.getElementById('generic-modal-title');
            const genericModalContent = document.getElementById('generic-modal-content');
            const genericModalCloseBtn = document.getElementById('generic-modal-close-btn');
            const beerModal = document.getElementById('beer-modal');
            const beerModalCloseBtn = document.getElementById('beer-modal-close-btn');
            const beerModalContent = document.getElementById('beer-modal-content');
            const beerLoading = document.getElementById('beer-loading');
            const beerRecommendation = document.getElementById('beer-recommendation');
            const feedbackModal = document.getElementById('feedback-modal');
            const feedbackModalCloseBtn = document.getElementById('feedback-modal-close-btn');
            const submitFeedbackBtn = document.getElementById('submit-feedback-btn');
            const feedbackTextarea = document.getElementById('feedback-textarea');

            try {
                console.log('üîê Attempting Firebase authentication...');
                await signInAnonymously(auth);
                console.log("‚úÖ Signed in anonymously to access Firestore.");

                // Test Firestore connection
                console.log('üîó Testing Firestore connection...');
                await testFirestoreConnection();

                console.log('üåê Setting language to Chinese...');
                switchLanguage('zh');

                console.log('‚öôÔ∏è Fetching app settings...');
                await fetchSettings();
                
                console.log('üëÇ Setting up real-time settings listener...');
                // Set up real-time settings listener
                setupSettingsListener();

                console.log('üîç Checking URL parameters...');
                const urlParams = new URLSearchParams(window.location.search);
                const source = urlParams.get('source');

                if (source === 'qrcode') {
                    console.log('üì± QR code source detected, showing registration page');
                    landingPageContainer.classList.add('hidden');
                    registerPage.classList.remove('hidden');
                } else {
                    console.log('üè† Default source, showing landing page');
                    landingPageContainer.classList.remove('hidden');
                    registerPage.classList.add('hidden');
                }
               
                console.log('‚ú® Creating visual effects...');
                createParticles();
                populateCountryCodes();
                drawWheel();
                
                console.log('üéØ Setting up event listeners...');
                registerForm.addEventListener('submit', handleRegistration);
                spinBtn.addEventListener('click', spin);
                modalCloseBtn.addEventListener('click', () => resultModal.classList.add('hidden'));
                document.getElementById('tnc-btn').addEventListener('click', () => showGenericModal('tnc'));
                document.getElementById('packages-btn').addEventListener('click', () => showGenericModal('packages'));
                genericModalCloseBtn.addEventListener('click', () => genericModal.classList.add('hidden'));
                document.getElementById('fast-track-btn').addEventListener('click', () => {
                    landingPageContainer.classList.add('hidden');
                    registerPage.classList.remove('hidden');
                });
                document.getElementById('beer-sommelier-btn').addEventListener('click', () => {
                    beerRecommendation.classList.add('hidden');
                    beerModal.classList.remove('hidden')
                });
                beerModalCloseBtn.addEventListener('click', () => beerModal.classList.add('hidden'));
                document.querySelectorAll('.beer-flavor-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleBeerRecommendation(btn.dataset.flavor));
                });
                document.getElementById('my-prizes-btn').addEventListener('click', () => showGenericModal('my-prizes'));
                document.getElementById('feedback-btn').addEventListener('click', () => feedbackModal.classList.remove('hidden'));
                feedbackModalCloseBtn.addEventListener('click', () => feedbackModal.classList.add('hidden'));
                submitFeedbackBtn.addEventListener('click', submitFeedback);

                // Clean up listeners when page unloads
                window.addEventListener('beforeunload', () => {
                    if (userDataListener) {
                        userDataListener();
                    }
                });

                console.log('üéâ App initialization completed successfully!');

            } catch (error) {
                console.error("‚ùå Firebase Initialization Error:", error);
                console.error("Error details:", {
                    name: error.name,
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                document.getElementById('app').innerHTML = `<div class="text-center p-4 bg-red-900 text-white rounded-lg"><h2 class="text-xl font-bold">Connection Error</h2><p>Could not connect to the lucky draw service. Please try again later.</p><p class="text-sm mt-2">Error: ${error.message}</p></div>`;
            }
        }

        initApp();
    </script>
</body>
</html>


