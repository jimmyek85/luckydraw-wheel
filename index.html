<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1602 Lucky Draw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a202c;
            color: #f7fafc;
        }
        .wheel-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: auto;
        }
        #canvas {
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .pointer {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #ff8a8a, #f56565);
            border: 5px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .pointer::after {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 15px solid white;
        }
        .modal-bg {
            background-color: rgba(0,0,0,0.7);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #landing-page-container {
            background: #0d0d0d;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            animation: fadeIn 1s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(253, 224, 71, 0.2);
            animation: float 25s infinite linear;
            bottom: -50px;
        }
        @keyframes float {
            0% { transform: translateY(0) translateX(0); opacity: 0.5; }
            100% { transform: translateY(-100vh) translateX(var(--x-end)); opacity: 0; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        #wheel-wrapper {
            border-radius: 50%;
            transition: box-shadow 0.5s ease-in-out;
        }
        .spinning-neon {
            animation: neon-flicker 1.5s infinite alternate;
        }
        @keyframes neon-flicker {
          from {
            box-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #f0f, 0 0 40px #f0f, 0 0 50px #f0f, 0 0 60px #f0f, 0 0 70px #f0f;
          }
          to {
            box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #0ff, 0 0 20px #0ff, 0 0 25px #0ff, 0 0 30px #0ff, 0 0 35px #0ff;
          }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-md mx-auto">

        <!-- Language Switcher -->
        <div class="text-center mb-4">
            <button id="lang-en" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm">English</button>
            <button id="lang-zh" class="px-3 py-1 bg-gray-600 text-white rounded-md text-sm">中文</button>
        </div>

        <!-- Engaging Landing Page -->
        <div id="landing-page-container">
            <div id="particles-container"></div>
            <div id="landing-page" class="text-center relative z-10">
                <h1 class="text-4xl font-bold mb-2 text-yellow-300" data-lang-en="A Surprise Awaits!">A Surprise Awaits!</h1>
                <p class="text-lg mb-4 text-white" data-lang-en="Meeting is fate, a gift is our bond.">Meeting is fate, a gift is our bond.</p>
                <div class="bg-white p-2 rounded-lg inline-block my-4 shadow-lg">
                     <img src="https://storage2.me-qr.com/qr/231358832.png" alt="1602 Lucky Draw QR Code" class="w-48 h-48">
                </div>
                <p class="mt-4 text-sm text-gray-300" data-lang-en="Scan or Click Below to Join!">Scan or Click Below to Join!</p>
                <button id="fast-track-btn" class="mt-6 w-full bg-gradient-to-r from-yellow-400 to-amber-500 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105" data-lang-en="Enter Now">Enter Now</button>
            </div>
        </div>

        <!-- Registration Form -->
        <div id="register-page" class="hidden">
            <h2 class="text-2xl font-bold text-center mb-4" data-lang-en="Become a 1602 Member">Become a 1602 Member</h2>
            <p class="text-center mb-6 text-gray-300" data-lang-en="Fill in your details to get 1 free spin!">Fill in your details to get 1 free spin!</p>
            <form id="register-form">
                <div class="mb-4">
                    <label for="name" class="block mb-2 text-sm font-medium" data-lang-en="Name (Required)">Name (Required)</label>
                    <input type="text" id="name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="phone" class="block mb-2 text-sm font-medium" data-lang-en="Phone (Required)">Phone (Required)</label>
                    <div class="flex">
                        <select id="country-code" class="bg-gray-700 border border-r-0 border-gray-600 rounded-l-lg p-2.5 text-white focus:outline-none">
                        </select>
                        <input type="tel" id="phone" class="w-full bg-gray-700 border border-gray-600 rounded-r-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" placeholder="1123456789" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="email" class="block mb-2 text-sm font-medium" data-lang-en="Email (Optional)">Email (Optional)</label>
                    <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="address" class="block mb-2 text-sm font-medium" data-lang-en="Address (Optional)">Address (Optional)</label>
                    <input type="text" id="address" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" id="submit-register" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105" data-lang-en="Submit & Get Spin!">Submit & Get Spin!</button>
            </form>
        </div>

        <!-- Lucky Wheel Page -->
        <div id="wheel-page" class="hidden text-center">
            <h2 class="text-3xl font-bold mb-2" data-lang-en="1602 Lucky Draw">1602 Lucky Draw</h2>
            <p class="mb-4" data-lang-en="Welcome, "><span id="user-name-display"></span>!</p>
            <div id="wheel-wrapper" class="p-2 inline-block">
                <div class="wheel-container">
                    <div class="pointer"></div>
                    <canvas id="canvas" width="400" height="400"></canvas>
                </div>
            </div>
            <button id="spin-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                <span data-lang-en="SPIN">SPIN</span> (<span id="chances-left">0</span> <span data-lang-en="chances left">chances left</span>)
            </button>
            <div class="mt-4 flex justify-center gap-4 flex-wrap">
                <button id="my-prizes-btn" class="text-sm text-gray-400 hover:text-white hidden" data-lang-en="My Prizes">My Prizes</button>
                <button id="tnc-btn" class="text-sm text-gray-400 hover:text-white" data-lang-en="Prize T&C">Prize T&C</button>
                <button id="beer-sommelier-btn" class="text-sm text-purple-400 hover:text-purple-300 font-bold" data-lang-en="✨ AI Beer Recommendation">✨ AI Beer Recommendation</button>
                <button id="packages-btn" class="text-sm text-gray-400 hover:text-white" data-lang-en="Our Packages">Our Packages</button>
                <button id="feedback-btn" class="text-sm text-gray-400 hover:text-white" data-lang-en="Feedback">Feedback</button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50 p-4">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-sm w-full mx-auto text-center">
            <h3 id="modal-title" class="text-3xl font-bold mb-4"></h3>
            <div id="modal-content">
                <p id="modal-text" class="text-lg mb-2"></p>
                <div id="online-voucher-instructions" class="hidden text-sm mt-4 p-3 bg-gray-700 rounded-lg">
                    <p class="font-bold mb-2" data-lang-en="How to Claim Your Online Voucher:">How to Claim Your Online Voucher:</p>
                    <p data-lang-en="Download our '1602craftbeer' app to redeem your prize!">Download our '1602craftbeer' app to redeem your prize!</p>
                    <div class="flex justify-center gap-4 mt-2">
                        <a href="https://apps.apple.com/your-app-link" target="_blank" class="opacity-80 hover:opacity-100"><img src="https://placehold.co/120x40/000000/FFFFFF?text=App+Store" alt="Download on the App Store"></a>
                        <a href="https://play.google.com/store/apps/details?id=your.app.id" target="_blank" class="opacity-80 hover:opacity-100"><img src="https://placehold.co/120x40/000000/FFFFFF?text=Google+Play" alt="Get it on Google Play"></a>
                    </div>
                </div>
                <button id="gemini-idea-btn" class="hidden w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 my-4">
                    ✨ <span data-lang-en="AI, give me an idea!">AI, give me an idea!</span>
                </button>
            </div>
            <div id="gemini-loading" class="hidden">
                <div class="loader"></div>
                <p data-lang-en="Our AI is thinking...">Our AI is thinking...</p>
            </div>
            <div id="share-section" class="mt-4 pt-4 border-t border-gray-600">
                <p class="mb-3 text-sm" data-lang-en="Share to get a RM2 cash voucher!">Share to get a RM2 cash voucher!</p>
                <div class="flex justify-center space-x-4">
                    <button onclick="share('facebook')" class="bg-blue-800 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v2.385z"/></svg></button>
                    <button onclick="share('instagram')" class="bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.069-4.85.069-3.204 0-3.584-.012-4.849-.069-3.225-.149-4.771-1.664-4.919-4.919-.058-1.265-.069-1.645-.069-4.849 0-3.204.012-3.584.069-4.849.149-3.225 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.689-.073-4.948-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44 1.441-.645 1.441-1.44-.645-1.44-1.441-1.44z"/></svg></button>
                    <button onclick="share('copy_whatsapp')" class="bg-gray-500 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                </div>
            </div>
            <button id="modal-close-btn" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg" data-lang-en="Close">Close</button>
        </div>
    </div>

    <!-- Generic Modal for T&C, Packages, and Announcements -->
    <div id="generic-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50 p-4">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-lg w-full mx-auto text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 id="generic-modal-title" class="text-2xl font-bold"></h3>
                <button id="generic-modal-close-btn" class="text-2xl leading-none">&times;</button>
            </div>
            <div id="generic-modal-content" class="text-gray-300 text-sm space-y-2 max-h-[60vh] overflow-y-auto">
            </div>
        </div>
    </div>

    <!-- AI Beer Sommelier Modal -->
    <div id="beer-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50 p-4">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-lg w-full mx-auto text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 id="beer-modal-title" class="text-2xl font-bold" data-lang-en="✨ AI Beer Sommelier">✨ AI Beer Sommelier</h3>
                <button id="beer-modal-close-btn" class="text-2xl leading-none">&times;</button>
            </div>
            <div id="beer-modal-content">
                <p class="mb-4" data-lang-en="What kind of flavor are you in the mood for?">What kind of flavor are you in the mood for?</p>
                <div class="space-y-3">
                    <button data-flavor="Pale Ale" class="beer-flavor-btn w-full text-left p-3 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors" data-lang-en="Pale Ale (Fruity & Light)">Pale Ale (Fruity & Light)</button>
                    <button data-flavor="Extra Dark" class="beer-flavor-btn w-full text-left p-3 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors" data-lang-en="Extra Dark (Rich & Malty)">Extra Dark (Rich & Malty)</button>
                    <button data-flavor="Lager" class="beer-flavor-btn w-full text-left p-3 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors" data-lang-en="Lager (Classic & Crisp)">Lager (Classic & Crisp)</button>
                </div>
            </div>
             <div id="beer-loading" class="hidden">
                <div class="loader"></div>
                <p class="text-center" data-lang-en="Our AI Sommelier is pouring a recommendation...">Our AI Sommelier is pouring a recommendation...</p>
            </div>
            <div id="beer-recommendation" class="hidden mt-4 text-purple-300 italic"></div>
        </div>
    </div>

    <!-- ADDED: Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50 p-4">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-lg w-full mx-auto text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold" data-lang-en="Give us your Feedback">Give us your Feedback</h3>
                <button id="feedback-modal-close-btn" class="text-2xl leading-none">&times;</button>
            </div>
            <div>
                <textarea id="feedback-textarea" class="w-full h-32 p-3 bg-gray-700 border border-gray-600 rounded-md text-white" data-lang-en-placeholder="Your feedback is valuable to us..."></textarea>
                <button id="submit-feedback-btn" class="mt-4 w-full bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition" data-lang-en="Submit Feedback">Submit Feedback</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDR9ApYQZbHJpbs3hSiY1wdGjSOIxWpZIY",
            authDomain: "deductive-smile-408711.firebaseapp.com",
            projectId: "deductive-smile-408711",
            storageBucket: "deductive-smile-408711.appspot.com",
            messagingSenderId: "209601875553",
            appId: "1:209601875553:web:d4a9175622134295c06420",
            measurementId: "G-R222P71DDD"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Enhanced error handling for Firestore connections
        let isFirestoreConnected = false;
        let retryCount = 0;
        const maxRetries = 3;

        async function testFirestoreConnection() {
            try {
                // Test connection with a simple read operation
                const testDoc = await getDoc(doc(db, 'test', 'connection'));
                isFirestoreConnected = true;
                console.log("Firestore connection successful");
                return true;
            } catch (error) {
                console.warn("Firestore connection test failed:", error.message);
                isFirestoreConnected = false;
                return false;
            }
        }

        async function retryFirestoreOperation(operation, fallback = null) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await operation();
                } catch (error) {
                    console.warn(`Firestore operation failed (attempt ${i + 1}/${maxRetries}):`, error.message);
                    if (i === maxRetries - 1) {
                        if (fallback) {
                            console.log("Using fallback for failed Firestore operation");
                            return fallback();
                        }
                        throw error;
                    }
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }

        const langData = {
            en: {
                "Welcome to 1602": "Welcome to 1602",
                "Scan the QR code to participate!": "Scan the QR code to participate!",
                "This is the official entry point for the 1602 Lucky Draw.": "This is the official entry point for the 1602 Lucky Draw.",
                "A Surprise Awaits!": "A Surprise Awaits!",
                "Meeting is fate, a gift is our bond.": "Meeting is fate, a gift is our bond.",
                "Scan or Click Below to Join!": "Scan or Click Below to Join!",
                "Enter Now": "Enter Now",
                "Become a 1602 Member": "Become a 1602 Member",
                "Fill in your details to get 1 free spin!": "Fill in your details to get 1 free spin!",
                "Name (Required)": "Name (Required)",
                "Phone (Required)": "Phone (Required)",
                "Email (Optional)": "Email (Optional)",
                "Address (Optional)": "Address (Optional)",
                "Submit & Get Spin!": "Submit & Get Spin!",
                "1602 Lucky Draw": "1602 Lucky Draw",
                "Welcome, ": "Welcome, ",
                "SPIN": "SPIN",
                "chances left": "chances left",
                "Share to get a RM2 cash voucher!": "Share to get a RM2 cash voucher!",
                "Close": "Close",
                "AI, give me an idea!": "AI, give me an idea!",
                "Our AI is thinking...": "Our AI is thinking...",
                "Prize T&C": "Prize T&C",
                "Our Packages": "Our Packages",
                "My Prizes": "My Prizes",
                "Feedback": "Feedback",
                "How to Claim Your Online Voucher:": "How to Claim Your Online Voucher:",
                "Download our '1602craftbeer' app to redeem your prize!": "Download our '1602craftbeer' app to redeem your prize!",
                "Terms & Conditions": "Terms & Conditions",
                "1602 Packages": "1602 Packages",
                "✨ AI Beer Recommendation": "✨ AI Beer Recommendation",
                "✨ AI Beer Sommelier": "✨ AI Beer Sommelier",
                "What kind of flavor are you in the mood for?": "What kind of flavor are you in the mood for?",
                "Pale Ale (Fruity & Light)": "Pale Ale (Fruity & Light)",
                "Extra Dark (Rich & Malty)": "Extra Dark (Rich & Malty)",
                "Lager (Classic & Crisp)": "Lager (Classic & Crisp)",
                "Our AI Sommelier is pouring a recommendation...": "Our AI Sommelier is pouring a recommendation...",
                "Event Announcement": "Event Announcement",
                "Your Prizes": "Your Prizes",
                "Like & Follow us on Facebook for an instant RM2 cash voucher!": "Like & Follow us on Facebook for an instant RM2 cash voucher!",
                "Search for 'Sarawakian Craft Beer - Kuching Beer Catering Service', show our staff, and claim your voucher now!": "Search for 'Sarawakian Craft Beer - Kuching Beer Catering Service', show our staff, and claim your voucher now!",
                "Give us your Feedback": "Give us your Feedback",
                "Your feedback is valuable to us...": "Your feedback is valuable to us...",
                "Submit Feedback": "Submit Feedback",
                "Feedback submitted. Thank you!": "Feedback submitted. Thank you!",
                "Cash Voucher RM5": "Cash Voucher RM5",
                "Online Voucher RM10": "Online Voucher RM10",
                "Online Voucher RM20": "Online Voucher RM20",
                "New 330ml Can": "New 330ml Can",
                "Free 660ml Bottle": "Free 660ml Bottle",
                "1602 Pen": "1602 Pen",
                "Cooler Bag": "Cooler Bag",
                "1602 Mug": "1602 Mug",
                "Thank You": "Thank You",
                "Spin Again!": "Spin Again!",
                "Congratulations!": "Congratulations!",
                "Oh No...": "Oh No...",
                "Awesome!": "Awesome!",
                "You won a": "You won a",
                "Better luck next time!": "Better luck next time!",
                "You get another free spin!": "You get another free spin!",
                "Copied to clipboard!": "Copied to clipboard!",
                "User already exists. Loading your data...": "User already exists. Loading your data...",
                "Registration successful!": "Registration successful!",
                "Please fill in required fields.": "Please fill in required fields.",
                "Please enter a valid phone number (digits only).": "Please enter a valid phone number (digits only)."
            },
            zh: {
                "Welcome to 1602": "欢迎来到 1602",
                "Scan the QR code to participate!": "请扫描二维码参与活动！",
                "This is the official entry point for the 1602 Lucky Draw.": "这是1602幸运轮盘的官方活动入口。",
                "A Surprise Awaits!": "扫码有惊喜！",
                "Meeting is fate, a gift is our bond.": "与你相遇是缘分，扫码送礼结情分。",
                "Scan or Click Below to Join!": "扫描或点击下方按钮参与！",
                "Enter Now": "快捷通道",
                "Become a 1602 Member": "成为 1602 会员",
                "Fill in your details to get 1 free spin!": "填写资料即可获得1次免费抽奖机会！",
                "Name (Required)": "名字（必填）",
                "Phone (Required)": "电话（必填）",
                "Email (Optional)": "邮箱（选填）",
                "Address (Optional)": "地址（选填）",
                "Submit & Get Spin!": "提交并获取抽奖机会！",
                "1602 Lucky Draw": "1602 幸运轮盘",
                "Welcome, ": "欢迎, ",
                "SPIN": "开始抽奖",
                "chances left": "次机会",
                "Share to get a RM2 cash voucher!": "成功分享可获得RM2现金券！",
                "Close": "关闭",
                "AI, give me an idea!": "AI给我一个好主意！",
                "Our AI is thinking...": "AI正在为您生成创意...",
                "Prize T&C": "领奖 T&C",
                "Our Packages": "优惠套餐",
                "My Prizes": "我的奖品",
                "Feedback": "客户反馈",
                "How to Claim Your Online Voucher:": "如何领取您的线上代金券:",
                "Download our '1602craftbeer' app to redeem your prize!": "请下载我们的 “1602craftbeer” App 领取您的奖励！",
                "Terms & Conditions": "条款与规定",
                "1602 Packages": "1602 优惠套餐",
                "✨ AI Beer Recommendation": "✨ AI 啤酒推荐",
                "✨ AI Beer Sommelier": "✨ AI 啤酒品鉴顾问",
                "What kind of flavor are you in the mood for?": "您今天想喝点什么口味？",
                "Pale Ale (Fruity & Light)": "清爽果香 (Pale Ale)",
                "Extra Dark (Rich & Malty)": "浓郁麦香 (Extra Dark)",
                "Lager (Classic & Crisp)": "经典原味 (Lager)",
                "Event Announcement": "活动公告",
                "Your Prizes": "您的奖品",
                "Like & Follow us on Facebook for an instant RM2 cash voucher!": "点赞并关注我们的FB，即可立即获得RM2现金券！",
                "Search for 'Sarawakian Craft Beer - Kuching Beer Catering Service', show our staff, and claim your voucher now!": "请搜索‘Sarawakian Craft Beer - Kuching Beer Catering Service’，向工作人员展示，即可马上使用您的现金券！",
                "Give us your Feedback": "给我们一些反馈",
                "Your feedback is valuable to us...": "您的反馈对我们非常宝贵...",
                "Submit Feedback": "提交反馈",
                "Feedback submitted. Thank you!": "反馈已提交，谢谢您！",
                "Cash Voucher RM5": "RM5 现金券",
                "Online Voucher RM10": "RM10 线上券",
                "Online Voucher RM20": "RM20 线上券",
                "New 330ml Can": "330ml罐装新品",
                "Free 660ml Bottle": "免费660ml瓶装",
                "1602 Pen": "1602纪念笔",
                "Cooler Bag": "保冷袋",
                "1602 Mug": "纪念酒杯",
                "Thank You": "谢谢参与",
                "Spin Again!": "再来一次！",
                "Congratulations!": "恭喜！",
                "Oh No...": "很遗憾...",
                "Awesome!": "太棒了！",
                "You won a": "您抽中了",
                "Better luck next time!": "祝您下次好运！",
                "You get another free spin!": "您获得了一次额外抽奖机会！",
                "Copied to clipboard!": "已复制到剪贴板！",
                "User already exists. Loading your data...": "用户已存在，正在加载您的数据...",
                "Registration successful!": "注册成功！",
                "Please fill in required fields.": "请填写必填项。",
                "Please enter a valid phone number (digits only).": "请输入有效的电话号码（仅限数字）。"
            }
        };

        // Global variables
        let currentLang = 'en';
        let knowledgeBaseContent = '';

        // Language switching function
        function switchLanguage(lang) {
            currentLang = lang;
            const elements = document.querySelectorAll('[data-lang-en]');
            elements.forEach(element => {
                const key = element.getAttribute('data-lang-en');
                if (langData[lang] && langData[lang][key]) {
                    element.textContent = langData[lang][key];
                }
            });
        }

        // Fetch settings from Firestore
        async function fetchSettings() {
            return await retryFirestoreOperation(
                async () => {
                    const settingsDoc = await getDoc(doc(db, 'settings', 'app'));
                    if (settingsDoc.exists()) {
                        const settings = settingsDoc.data();
                        if (settings.announcement) {
                            showAnnouncement(settings.announcement);
                        }
                        if (settings.knowledge) {
                            knowledgeBaseContent = settings.knowledge;
                        }
                    }
                },
                () => {
                    // Fallback: use default settings
                    console.log("Using default settings due to Firestore connection issues");
                    knowledgeBaseContent = "Default knowledge base content";
                }
            );
        }

        // Show announcement modal
        function showAnnouncement(announcement) {
            if (announcement.trim()) {
                const modal = document.getElementById('generic-modal');
                const title = document.getElementById('generic-modal-title');
                const content = document.getElementById('generic-modal-content');
                
                title.textContent = langData[currentLang]["Event Announcement"] || "Event Announcement";
                content.innerHTML = `<p class="text-gray-700">${announcement}</p>`;
                modal.classList.remove('hidden');
            }
        }

        // Create background particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 2) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Populate country codes dropdown
        function populateCountryCodes() {
            const countryCodeSelect = document.getElementById('country-code');
            if (!countryCodeSelect) return;
            
            const countryCodes = [
                { code: '+60', country: 'Malaysia' },
                { code: '+65', country: 'Singapore' },
                { code: '+1', country: 'US/Canada' },
                { code: '+44', country: 'UK' },
                { code: '+86', country: 'China' },
                { code: '+81', country: 'Japan' },
                { code: '+82', country: 'South Korea' }
            ];
            
            countryCodes.forEach(item => {
                const option = document.createElement('option');
                option.value = item.code;
                option.textContent = `${item.code} ${item.country}`;
                countryCodeSelect.appendChild(option);
            });
        }

        // Draw the wheel
        function drawWheel() {
            const canvas = document.getElementById('canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 180;
            
            const prizes = [
                { text: 'Cash Voucher RM5', color: '#4ECDC4', textColor: '#FFFFFF', weight: 8 },
                { text: 'Spin Again!', color: '#F8C471', textColor: '#2D3436', weight: 8 },
                { text: '1602 Pen', color: '#98D8C8', textColor: '#2D3436', weight: 8 },
                { text: 'Cooler Bag', color: '#F7DC6F', textColor: '#2D3436', weight: 6 },
                { text: 'Online Voucher RM10', color: '#45B7D1', textColor: '#FFFFFF', weight: 5 },
                { text: 'Online Voucher RM20', color: '#96CEB4', textColor: '#FFFFFF', weight: 4 },
                { text: 'New 330ml Can', color: '#FFEAA7', textColor: '#2D3436', weight: 5 },
                { text: 'Free 660ml Bottle', color: '#DDA0DD', textColor: '#FFFFFF', weight: 5 },
                { text: 'Thank You', color: '#85C1E9', textColor: '#2D3436', weight: 5 },
                { text: '1602 Mug', color: '#BB8FCE', textColor: '#FFFFFF', weight: 1 }
            ];
            
            // Create weighted prize array for fair distribution
            weightedPrizes = [];
            prizes.forEach(prize => {
                for (let i = 0; i < prize.weight; i++) {
                    weightedPrizes.push(prize);
                }
            });
            
            // Shuffle the weighted prizes for random distribution
            for (let i = weightedPrizes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [weightedPrizes[i], weightedPrizes[j]] = [weightedPrizes[j], weightedPrizes[i]];
            }
            
            // Take first 12 for the wheel display
            const displayPrizes = weightedPrizes.slice(0, 12);
            
            const anglePerSlice = (2 * Math.PI) / displayPrizes.length;
            
            displayPrizes.forEach((prize, index) => {
                const startAngle = index * anglePerSlice;
                const endAngle = startAngle + anglePerSlice;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = prize.color;
                ctx.fill();
                ctx.stroke();
                
                // Draw text
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(startAngle + anglePerSlice / 2);
                ctx.textAlign = 'center';
                ctx.fillStyle = prize.textColor;
                ctx.font = 'bold 12px Arial';
                ctx.fillText(prize.text, radius * 0.7, 5);
                ctx.restore();
            });
        }

        // Global DOM elements for registration
        let nameElement, phoneElement, emailElement, addressElement, countryCodeElement;
        let userNameDisplayElement, chancesLeftElement;
        let landingPageContainer, registerPage, wheelPage;
        
        // Global prize configuration
        let weightedPrizes = [];

        // Handle registration form submission
        async function handleRegistration(e) {
            e.preventDefault();
            
            // Check if all required elements exist
            if (!nameElement || !phoneElement || !countryCodeElement || 
                !userNameDisplayElement || !chancesLeftElement ||
                !landingPageContainer || !registerPage || !wheelPage) {
                console.error("Required DOM elements not found for registration");
                alert("页面加载错误，请刷新页面重试");
                return;
            }
            
            const name = nameElement.value.trim();
            const countryCode = countryCodeElement.value;
            const phone = phoneElement.value.trim();
            const email = emailElement ? emailElement.value.trim() : '';
            const address = addressElement ? addressElement.value.trim() : '';
            
            if (!name || !phone) {
                alert(langData[currentLang]["Please fill in required fields."] || "Please fill in required fields.");
                return;
            }
            
            if (!/^\d+$/.test(phone)) {
                alert(langData[currentLang]["Please enter a valid phone number (digits only)."] || "Please enter a valid phone number (digits only).");
                return;
            }
            
            const fullPhone = countryCode + phone;
            
            try {
                await retryFirestoreOperation(
                    async () => {
                        const userRef = doc(db, 'users', fullPhone);
                        const userDoc = await getDoc(userRef);
                        
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            userNameDisplayElement.textContent = userData.name;
                            chancesLeftElement.textContent = userData.chances || 0;
                            alert(langData[currentLang]["User already exists. Loading your data..."] || "User already exists. Loading your data...");
                        } else {
                            await setDoc(userRef, {
                                name: name,
                                phone: fullPhone,
                                email: email || '',
                                address: address || '',
                                chances: 1,
                                prizes: [],
                                createdAt: new Date()
                            });
                            
                            userNameDisplayElement.textContent = name;
                            chancesLeftElement.textContent = '1';
                            alert(langData[currentLang]["Registration successful!"] || "Registration successful!");
                        }
                    },
                    () => {
                        // Fallback: store user data locally
                        console.log("Storing user data locally due to connection issues");
                        const userData = {
                            name: name,
                            phone: fullPhone,
                            email: email || '',
                            address: address || '',
                            chances: 1,
                            prizes: [],
                            createdAt: new Date().toISOString()
                        };
                        localStorage.setItem('currentUser', JSON.stringify(userData));
                        localStorage.setItem('pendingRegistration', JSON.stringify(userData));
                        
                        userNameDisplayElement.textContent = name;
                        chancesLeftElement.textContent = '1';
                        alert("注册成功！数据已保存到本地，连接恢复后会自动同步。");
                    }
                );
                
                // Switch to wheel page
                landingPageContainer.classList.add('hidden');
                registerPage.classList.add('hidden');
                wheelPage.classList.remove('hidden');
                
            } catch (error) {
                console.error("Registration error:", error);
                
                // Fallback: store locally and continue
                const userData = {
                    name: name,
                    phone: fullPhone,
                    email: email || '',
                    address: address || '',
                    chances: 1,
                    prizes: [],
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('currentUser', JSON.stringify(userData));
                localStorage.setItem('pendingRegistration', JSON.stringify(userData));
                
                userNameDisplayElement.textContent = name;
                chancesLeftElement.textContent = '1';
                
                alert("网络连接不稳定，但注册已完成！数据已保存到本地。");
                
                // Switch to wheel page
                landingPageContainer.classList.add('hidden');
                registerPage.classList.add('hidden');
                wheelPage.classList.remove('hidden');
            }
        }

        // Spin the wheel
        async function spin() {
            const spinBtn = document.getElementById('spin-btn');
            const chancesLeftElement = document.getElementById('chances-left');
            const wheel = document.getElementById('canvas');
            const wrapper = document.getElementById('wheel-wrapper');
            
            // Check if all required elements exist
            if (!spinBtn || !chancesLeftElement || !wheel || !wrapper) {
                console.error("Required DOM elements not found for spin");
                alert("页面加载错误，请刷新页面重试");
                return;
            }
            
            const chancesLeft = parseInt(chancesLeftElement.textContent);
            
            if (chancesLeft <= 0) {
                alert("No chances left!");
                return;
            }
            
            spinBtn.disabled = true;
            
            // Simulate spinning animation
            wrapper.classList.add('spinning-neon');
            
            const randomRotation = Math.random() * 360 + 1440; // At least 4 full rotations
            wheel.style.transform = `rotate(${randomRotation}deg)`;
            
            setTimeout(() => {
                wrapper.classList.remove('spinning-neon');
                
                // Use weighted probability system for fair prize distribution
                const totalWeight = weightedPrizes.length;
                const randomIndex = Math.floor(Math.random() * totalWeight);
                const wonPrize = weightedPrizes[randomIndex].text;
                
                showPrizeModal(wonPrize);
                spinBtn.disabled = false;
                
                // Update chances
                const newChances = wonPrize === 'Spin Again!' ? chancesLeft : chancesLeft - 1;
                chancesLeftElement.textContent = newChances;
                
            }, 3000);
        }

        // Show prize modal with AI-powered promotion
        function showPrizeModal(prize) {
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            const geminiIdeaBtn = document.getElementById('gemini-idea-btn');
            
            if (prize === 'Thank You') {
                title.textContent = langData[currentLang]["Oh No..."] || "Oh No...";
                content.innerHTML = `
                    <p>${langData[currentLang]["Better luck next time!"] || "Better luck next time!"}</p>
                    <div class="mt-4 p-3 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg">
                        <p class="text-sm text-white mb-2">🎯 别灰心！关注我们获得更多机会：</p>
                        <div class="flex gap-2">
                            <button onclick="window.open('https://www.facebook.com/1602craftbeer', '_blank')" class="flex-1 bg-blue-700 hover:bg-blue-800 text-white py-2 px-3 rounded text-xs">
                                Facebook
                            </button>
                            <button onclick="window.open('https://www.instagram.com/1602craftbeer', '_blank')" class="flex-1 bg-pink-600 hover:bg-pink-700 text-white py-2 px-3 rounded text-xs">
                                Instagram
                            </button>
                        </div>
                    </div>
                `;
                geminiIdeaBtn.classList.remove('hidden');
            } else if (prize === 'Spin Again!') {
                title.textContent = langData[currentLang]["Awesome!"] || "Awesome!";
                content.innerHTML = `
                    <p>${langData[currentLang]["You get another free spin!"] || "You get another free spin!"}</p>
                    <div class="mt-4 p-3 bg-green-600 rounded-lg">
                        <p class="text-sm text-white">🍀 幸运女神眷顾！分享给朋友一起来玩吧！</p>
                        <button onclick="shareToFriends()" class="mt-2 w-full bg-green-700 hover:bg-green-800 text-white py-2 px-4 rounded text-sm">
                            分享给朋友
                        </button>
                    </div>
                `;
            } else {
                title.textContent = langData[currentLang]["Congratulations!"] || "Congratulations!";
                content.innerHTML = `
                    <p>${langData[currentLang]["You won a"] || "You won a"} ${langData[currentLang][prize] || prize}!</p>
                    <div class="mt-4 p-3 bg-yellow-600 rounded-lg">
                        <p class="text-sm text-white mb-2">🎉 恭喜中奖！快来我们店里兑换奖品吧！</p>
                        <div class="flex gap-2">
                            <button onclick="getStoreLocation()" class="flex-1 bg-yellow-700 hover:bg-yellow-800 text-white py-2 px-3 rounded text-xs">
                                店铺位置
                            </button>
                            <button onclick="callStore()" class="flex-1 bg-yellow-700 hover:bg-yellow-800 text-white py-2 px-3 rounded text-xs">
                                联系我们
                            </button>
                        </div>
                    </div>
                `;
                geminiIdeaBtn.classList.remove('hidden');
            }
            
            modal.classList.remove('hidden');
        }

        // Show generic modal
        function showGenericModal(type) {
            const modal = document.getElementById('generic-modal');
            const title = document.getElementById('generic-modal-title');
            const content = document.getElementById('generic-modal-content');
            
            switch(type) {
                case 'tnc':
                    title.textContent = langData[currentLang]["Terms & Conditions"] || "Terms & Conditions";
                    content.innerHTML = `
                        <div class="space-y-4 text-gray-700">
                            <h4 class="font-semibold">${langData[currentLang]["How to Claim Your Online Voucher:"] || "How to Claim Your Online Voucher:"}</h4>
                            <p>${langData[currentLang]["Download our '1602craftbeer' app to redeem your prize!"] || "Download our '1602craftbeer' app to redeem your prize!"}</p>
                        </div>
                    `;
                    break;
                case 'packages':
                    title.textContent = langData[currentLang]["1602 Packages"] || "1602 Packages";
                    content.innerHTML = `<p class="text-gray-700">Package information will be displayed here.</p>`;
                    break;
                case 'my-prizes':
                    title.textContent = langData[currentLang]["Your Prizes"] || "Your Prizes";
                    content.innerHTML = `<p class="text-gray-700">Your prize history will be displayed here.</p>`;
                    break;
            }
            
            modal.classList.remove('hidden');
        }

        // Handle beer recommendation with real Gemini AI
        async function handleBeerRecommendation(flavor) {
            const loading = document.getElementById('beer-loading');
            const recommendation = document.getElementById('beer-recommendation');
            
            loading.classList.remove('hidden');
            recommendation.classList.add('hidden');
            
            try {
                const apiKey = "AIzaSyDR9ApYQZbHJpbs3hSiY1wdGjSOIxWpZIY";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const prompt = `作为1602精酿啤酒的AI品鉴顾问，请为喜欢${flavor}口味的顾客推荐我们的产品。请用温馨友好的语调，包含以下内容：
                1. 推荐具体的1602啤酒产品
                2. 描述口感特点
                3. 建议搭配场景
                4. 鼓励顾客到店体验或关注我们的社交媒体
                请用中文回复，控制在100字以内。`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: prompt }] }]
                    })
                });
                
                const data = await response.json();
                const aiRecommendation = data.candidates[0].content.parts[0].text;
                
                loading.classList.add('hidden');
                recommendation.classList.remove('hidden');
                recommendation.innerHTML = `<p class="text-purple-300 italic">${aiRecommendation}</p>
                    <div class="mt-4 p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-yellow-300">🎁 特别优惠：关注我们的Facebook获得RM2现金券！</p>
                        <button onclick="window.open('https://www.facebook.com/1602craftbeer', '_blank')" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm">
                            立即关注 Facebook
                        </button>
                    </div>`;
                
            } catch (error) {
                console.error("AI recommendation error:", error);
                loading.classList.add('hidden');
                recommendation.classList.remove('hidden');
                
                const fallbackRecommendations = {
                    'Pale Ale': '🍺 推荐我们的1602淡色艾尔！清新果香，口感轻盈，非常适合初次尝试精酿啤酒的朋友。搭配海鲜或沙拉享用更佳！',
                    'Extra Dark': '🍺 试试我们的1602黑啤！浓郁麦香，带有巧克力和咖啡的香气，口感醇厚。最适合搭配烧烤或甜点！',
                    'Lager': '🍺 经典1602拉格啤酒！清爽干净，麦芽平衡，是聚会和日常放松的完美选择。冰镇后享用口感更佳！'
                };
                
                recommendation.innerHTML = `<p class="text-purple-300 italic">${fallbackRecommendations[flavor]}</p>
                    <div class="mt-4 p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-yellow-300">🎁 关注我们获得更多优惠！</p>
                        <button onclick="window.open('https://www.facebook.com/1602craftbeer', '_blank')" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm">
                            关注 Facebook
                        </button>
                    </div>`;
            }
        }

        // AI-powered creative ideas for promotion
        async function generateCreativeIdea() {
            const geminiIdeaBtn = document.getElementById('gemini-idea-btn');
            const geminiLoading = document.getElementById('gemini-loading');
            const modalContent = document.getElementById('modal-content');
            
            geminiIdeaBtn.style.display = 'none';
            geminiLoading.classList.remove('hidden');
            
            try {
                const apiKey = "AIzaSyDR9ApYQZbHJpbs3hSiY1wdGjSOIxWpZIY";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const prompt = `作为1602精酿啤酒的营销AI助手，请为用户提供一个创意的推广建议。内容应该包括：
                1. 一个有趣的啤酒相关活动建议
                2. 如何在社交媒体上分享
                3. 鼓励朋友参与的方式
                4. 获得额外优惠的方法
                请用轻松有趣的语调，中文回复，控制在80字以内。`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: prompt }] }]
                    })
                });
                
                const data = await response.json();
                const aiIdea = data.candidates[0].content.parts[0].text;
                
                geminiLoading.classList.add('hidden');
                
                // Add AI idea to modal content
                const ideaDiv = document.createElement('div');
                ideaDiv.className = 'mt-4 p-4 bg-purple-600 rounded-lg';
                ideaDiv.innerHTML = `
                    <h4 class="text-white font-bold mb-2">🤖 AI创意建议</h4>
                    <p class="text-purple-100 text-sm">${aiIdea}</p>
                    <button onclick="shareAIIdea('${aiIdea.replace(/'/g, "\\'")}'))" class="mt-3 w-full bg-purple-700 hover:bg-purple-800 text-white py-2 px-4 rounded text-sm">
                        分享这个创意
                    </button>
                `;
                modalContent.appendChild(ideaDiv);
                
            } catch (error) {
                console.error("AI idea generation error:", error);
                geminiLoading.classList.add('hidden');
                
                const fallbackIdeas = [
                    "🍻 拍张你和朋友的干杯照片，标记我们获得惊喜优惠！邀请3个朋友关注我们，你们都能获得特别折扣！",
                    "🎉 在Instagram上分享你的1602时刻，使用#1602精酿 标签，有机会赢得免费啤酒品鉴套装！",
                    "🌟 组织一场小型聚会，用1602啤酒招待朋友，拍照分享到朋友圈，我们会送你下次聚会的啤酒！"
                ];
                
                const randomIdea = fallbackIdeas[Math.floor(Math.random() * fallbackIdeas.length)];
                
                const ideaDiv = document.createElement('div');
                ideaDiv.className = 'mt-4 p-4 bg-purple-600 rounded-lg';
                ideaDiv.innerHTML = `
                    <h4 class="text-white font-bold mb-2">💡 创意建议</h4>
                    <p class="text-purple-100 text-sm">${randomIdea}</p>
                    <button onclick="shareAIIdea('${randomIdea.replace(/'/g, "\\'")}'))" class="mt-3 w-full bg-purple-700 hover:bg-purple-800 text-white py-2 px-4 rounded text-sm">
                        分享这个创意
                    </button>
                `;
                modalContent.appendChild(ideaDiv);
            }
        }
        
        // Share AI-generated idea
        function shareAIIdea(idea) {
            const shareText = `🍺 1602精酿啤酒AI推荐：${idea} 快来参加我们的幸运抽奖活动！`;
            
            if (navigator.share) {
                navigator.share({
                    title: '1602精酿啤酒 - AI创意分享',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('创意内容已复制到剪贴板！快去分享吧！');
                });
            }
        }
        
        // Share to friends function
        function shareToFriends() {
            const shareText = '🍀 我在1602精酿啤酒抽奖中又获得了一次机会！快来一起参加吧！';
            const shareUrl = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: '1602精酿啤酒幸运抽奖',
                    text: shareText,
                    url: shareUrl
                });
            } else {
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`;
                window.open(whatsappUrl, '_blank');
            }
        }
        
        // Get store location
        function getStoreLocation() {
            const storeInfo = `
                📍 1602精酿啤酒店铺位置：
                地址：[请填入实际地址]
                营业时间：周一至周日 11:00-23:00
                电话：[请填入联系电话]
            `;
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(() => {
                    // 这里可以集成地图API显示路线
                    alert(storeInfo + '\n\n正在为您规划路线...');
                });
            } else {
                alert(storeInfo);
            }
        }
        
        // Call store function
         function callStore() {
             const phoneNumber = 'tel:+60123456789'; // 请替换为实际电话号码
             window.location.href = phoneNumber;
         }
         
         // Submit feedback
         async function submitFeedback() {
             const textarea = document.getElementById('feedback-textarea');
             const feedback = textarea.value.trim();
             
             if (!feedback) return;
             
             try {
                 await retryFirestoreOperation(
                     async () => {
                         await addDoc(collection(db, 'feedback'), {
                             feedback: feedback,
                             timestamp: new Date()
                         });
                     },
                     () => {
                         // Fallback: store locally
                         console.log("Storing feedback locally due to connection issues");
                         const localFeedback = JSON.parse(localStorage.getItem('pendingFeedback') || '[]');
                         localFeedback.push({
                             feedback: feedback,
                             timestamp: new Date().toISOString()
                         });
                         localStorage.setItem('pendingFeedback', JSON.stringify(localFeedback));
                     }
                 );
                 
                 alert(langData[currentLang]["Feedback submitted. Thank you!"] || "Feedback submitted. Thank you!");
                 textarea.value = '';
                 document.getElementById('feedback-modal').classList.add('hidden');
             } catch (error) {
                 console.error("Error submitting feedback:", error);
                 alert("反馈提交失败，但已保存到本地。我们会在连接恢复后处理您的反馈。");
                 
                 // Store locally as fallback
                 const localFeedback = JSON.parse(localStorage.getItem('pendingFeedback') || '[]');
                 localFeedback.push({
                     feedback: feedback,
                     timestamp: new Date().toISOString()
                 });
                 localStorage.setItem('pendingFeedback', JSON.stringify(localFeedback));
                 
                 textarea.value = '';
                 document.getElementById('feedback-modal').classList.add('hidden');
             }
         }
        
        // All other variables and functions are defined below but omitted for brevity.
        // The full, correct code is in the script.
        
        async function initApp() {
            // Wait for DOM to be fully loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initApp);
                return;
            }
            
            // Initialize global DOM elements for registration
            nameElement = document.getElementById('name');
            phoneElement = document.getElementById('phone');
            emailElement = document.getElementById('email');
            addressElement = document.getElementById('address');
            countryCodeElement = document.getElementById('country-code');
            userNameDisplayElement = document.getElementById('user-name-display');
            chancesLeftElement = document.getElementById('chances-left');
            landingPageContainer = document.getElementById('landing-page-container');
            registerPage = document.getElementById('register-page');
            wheelPage = document.getElementById('wheel-page');
            
            // FIXED: Moved all element lookups inside initApp to run after DOM is loaded
            const registerForm = document.getElementById('register-form');
            const spinBtn = document.getElementById('spin-btn');
            const chancesLeftSpan = document.getElementById('chances-left');
            const userNameDisplay = document.getElementById('user-name-display');
            const resultModal = document.getElementById('result-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalText = document.getElementById('modal-text');
            const onlineVoucherInstructions = document.getElementById('online-voucher-instructions');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const geminiIdeaBtn = document.getElementById('gemini-idea-btn');
            const geminiLoading = document.getElementById('gemini-loading');
            const genericModal = document.getElementById('generic-modal');
            const genericModalTitle = document.getElementById('generic-modal-title');
            const genericModalContent = document.getElementById('generic-modal-content');
            const genericModalCloseBtn = document.getElementById('generic-modal-close-btn');
            const beerModal = document.getElementById('beer-modal');
            const beerModalCloseBtn = document.getElementById('beer-modal-close-btn');
            const beerModalContent = document.getElementById('beer-modal-content');
            const beerLoading = document.getElementById('beer-loading');
            const beerRecommendation = document.getElementById('beer-recommendation');
            const feedbackModal = document.getElementById('feedback-modal');
            const feedbackModalCloseBtn = document.getElementById('feedback-modal-close-btn');
            const submitFeedbackBtn = document.getElementById('submit-feedback-btn');
            const feedbackTextarea = document.getElementById('feedback-textarea');

            // Check if essential elements exist
            if (!landingPageContainer || !registerPage || !wheelPage || !registerForm) {
                console.error("Essential DOM elements not found");
                return;
            }

            try {
                // Test Firestore connection first
                console.log("Testing Firestore connection...");
                const connectionTest = await testFirestoreConnection();
                
                if (!connectionTest) {
                    console.warn("Firestore connection failed, but continuing with limited functionality");
                }

                await signInAnonymously(auth);
                console.log("Signed in anonymously to access Firestore.");

                switchLanguage('zh');

                // Try to fetch settings with fallback
                try {
                    await fetchSettings();
                } catch (error) {
                    console.warn("Failed to fetch settings, using defaults:", error.message);
                }

                const urlParams = new URLSearchParams(window.location.search);
                const source = urlParams.get('source');

                if (source === 'qrcode') {
                    landingPageContainer.classList.add('hidden');
                    registerPage.classList.remove('hidden');
                } else {
                    landingPageContainer.classList.remove('hidden');
                    registerPage.classList.add('hidden');
                }
               
                createParticles();
                populateCountryCodes();
                drawWheel();
                
                // Add event listeners with null checks
                if (registerForm) registerForm.addEventListener('submit', handleRegistration);
                if (spinBtn) spinBtn.addEventListener('click', spin);
                if (modalCloseBtn && resultModal) modalCloseBtn.addEventListener('click', () => resultModal.classList.add('hidden'));
                
                const tncBtn = document.getElementById('tnc-btn');
                const packagesBtn = document.getElementById('packages-btn');
                const fastTrackBtn = document.getElementById('fast-track-btn');
                const beerSommelierBtn = document.getElementById('beer-sommelier-btn');
                const myPrizesBtn = document.getElementById('my-prizes-btn');
                const feedbackBtn = document.getElementById('feedback-btn');
                
                if (tncBtn) tncBtn.addEventListener('click', () => showGenericModal('tnc'));
                if (packagesBtn) packagesBtn.addEventListener('click', () => showGenericModal('packages'));
                if (genericModalCloseBtn && genericModal) genericModalCloseBtn.addEventListener('click', () => genericModal.classList.add('hidden'));
                if (fastTrackBtn) fastTrackBtn.addEventListener('click', () => {
                    landingPageContainer.classList.add('hidden');
                    registerPage.classList.remove('hidden');
                });
                if (beerSommelierBtn && beerModal && beerRecommendation) beerSommelierBtn.addEventListener('click', () => {
                    beerRecommendation.classList.add('hidden');
                    beerModal.classList.remove('hidden')
                });
                if (beerModalCloseBtn && beerModal) beerModalCloseBtn.addEventListener('click', () => beerModal.classList.add('hidden'));
                
                document.querySelectorAll('.beer-flavor-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleBeerRecommendation(btn.dataset.flavor));
                });
                
                if (myPrizesBtn) myPrizesBtn.addEventListener('click', () => showGenericModal('my-prizes'));
                if (feedbackBtn && feedbackModal) feedbackBtn.addEventListener('click', () => feedbackModal.classList.remove('hidden'));
                if (feedbackModalCloseBtn && feedbackModal) feedbackModalCloseBtn.addEventListener('click', () => feedbackModal.classList.add('hidden'));
                if (submitFeedbackBtn) submitFeedbackBtn.addEventListener('click', submitFeedback);
                
                // AI creative idea button
                if (geminiIdeaBtn) geminiIdeaBtn.addEventListener('click', generateCreativeIdea);

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                
                // Show user-friendly error message
                const appElement = document.getElementById('app');
                if (appElement) {
                    appElement.innerHTML = `
                        <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center p-4">
                            <div class="text-center p-8 bg-white rounded-lg shadow-lg max-w-md">
                                <div class="text-6xl mb-4">🔄</div>
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">连接中...</h2>
                                <p class="text-gray-600 mb-6">正在尝试连接到服务器，请稍候...</p>
                                <button onclick="location.reload()" class="bg-amber-600 text-white px-6 py-3 rounded-lg hover:bg-amber-700 transition-colors">
                                    重新加载
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // Retry after 3 seconds
                setTimeout(() => {
                    console.log("Retrying initialization...");
                    location.reload();
                }, 3000);
            }
        }

        initApp();
    </script>
</body>
</html>


